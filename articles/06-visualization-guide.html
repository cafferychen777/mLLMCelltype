<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Visualization Guide • mLLMCelltype</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Fira_Mono-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Roboto_Slab-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Visualization Guide">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
  /* Fix for navbar overlapping main content */
  main {
    padding-top: 70px; /* Adjust this value as needed */
  }
  /* Improve spacing for better readability */
  .page-header {
    margin-top: 20px;
  }
  /* Ensure content has enough space from the top on mobile */
  @media (max-width: 767px) {
    main {
      padding-top: 80px; /* Slightly more padding on mobile */
    }
  }
  /* Better spacing for section headers */
  h2, h3, h4 {
    margin-top: 2rem;
    margin-bottom: 1rem;
  }
</style>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mLLMCelltype</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.2.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/01-introduction.html">Introduction</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Function Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/index.html">All Articles</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Getting Started</h6></li>
    <li><a class="dropdown-item" href="../articles/01-introduction.html">Introduction to mLLMCelltype</a></li>
    <li><a class="dropdown-item" href="../articles/02-installation.html">Installation Guide</a></li>
    <li><a class="dropdown-item" href="../articles/03-getting-started.html">Getting Started</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Usage and Features</h6></li>
    <li><a class="dropdown-item" href="../articles/04-usage-tutorial.html">Usage Tutorial</a></li>
    <li><a class="dropdown-item" href="../articles/05-consensus-principles.html">Consensus Annotation Principles</a></li>
    <li><a class="dropdown-item" href="../articles/06-visualization-guide.html">Visualization Guide</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced Topics</h6></li>
    <li><a class="dropdown-item" href="../articles/07-faq.html">Frequently Asked Questions</a></li>
    <li><a class="dropdown-item" href="../articles/08-advanced-features.html">Advanced Features &amp; Case Studies</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Development</h6></li>
    <li><a class="dropdown-item" href="../articles/09-contributing-guide.html">Contributing Guide</a></li>
    <li><a class="dropdown-item" href="../articles/10-version-history.html">Version History &amp; Changelog</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://www.biorxiv.org/content/10.1101/2025.04.10.647852v1" aria-label="Paper"><span class="bi bi-file-earmark-text"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cafferychen777/mLLMCelltype" aria-label="GitHub"><span class="bi bi-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Visualization Guide</h1>
                        <h4 data-toc-skip class="author">Chen Yang</h4>
            
            <h4 data-toc-skip class="date">2025-04-30</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/cafferychen777/mLLMCelltype/blob/dev/vignettes/06-visualization-guide.Rmd" class="external-link"><code>vignettes/06-visualization-guide.Rmd</code></a></small>
      <div class="d-none name"><code>06-visualization-guide.Rmd</code></div>
    </div>

    
    
<p><img src="../reference/figures/logo.png" align="right" height="139" alt="mLLMCelltype logo"></p>
<div class="section level2">
<h2 id="visualization-guide">Visualization Guide<a class="anchor" aria-label="anchor" href="#visualization-guide"></a>
</h2>
<p>This guide provides detailed instructions for visualizing
mLLMCelltype results. Creating effective visualizations is crucial for
interpreting cell type annotations and communicating uncertainty metrics
in your single-cell RNA sequencing analysis.</p>
<div class="section level3">
<h3 id="basic-visualization-concepts">Basic Visualization Concepts<a class="anchor" aria-label="anchor" href="#basic-visualization-concepts"></a>
</h3>
<p>mLLMCelltype provides three key types of information that can be
visualized:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Cell Type Annotations</strong>: The final cell type labels
assigned to each cluster</li>
<li>
<strong>Consensus Proportion</strong>: A measure of agreement among
models (0-1)</li>
<li>
<strong>Shannon Entropy</strong>: A measure of uncertainty in the
annotations (lower is better)</li>
</ol>
<p>These can be visualized separately or combined into informative
multi-panel figures.</p>
</div>
<div class="section level3">
<h3 id="integrating-with-seurat">Integrating with Seurat<a class="anchor" aria-label="anchor" href="#integrating-with-seurat"></a>
</h3>
<div class="section level4">
<h4 id="adding-mllmcelltype-results-to-seurat-objects">Adding mLLMCelltype Results to Seurat Objects<a class="anchor" aria-label="anchor" href="#adding-mllmcelltype-results-to-seurat-objects"></a>
</h4>
<p>Before visualization, you need to add the mLLMCelltype results to
your Seurat object:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cafferyang.com/mLLMCelltype/" class="external-link">mLLMCelltype</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assuming you have a Seurat object named 'seurat_obj' and consensus results</span></span>
<span><span class="co"># First, check the structure of consensus_results</span></span>
<span><span class="co"># Print the structure of consensus_results to understand its format</span></span>
<span><span class="co"># str(consensus_results)</span></span>
<span><span class="co"># print(names(consensus_results))</span></span>
<span><span class="co"># print(names(consensus_results$final_annotations))</span></span>
<span></span>
<span><span class="co"># Get cluster IDs from Seurat object</span></span>
<span><span class="va">cluster_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://satijalab.github.io/seurat-object/reference/Idents.html" class="external-link">Idents</a></span><span class="op">(</span><span class="va">seurat_obj</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Cluster IDs in Seurat object:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">cluster_ids</span>, collapse<span class="op">=</span><span class="st">", "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert final_annotations to a vector if it's a list</span></span>
<span><span class="va">final_annotations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">consensus_results</span><span class="op">$</span><span class="va">final_annotations</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Final annotations:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">final_annotations</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">", "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a mapping between cluster IDs and annotations</span></span>
<span><span class="va">annotation_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"character"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">cluster_ids</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">annotation_map</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">cluster_ids</span></span>
<span></span>
<span><span class="co"># First, try direct mapping where cluster ID matches the name in final_annotations</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">cluster_ids</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cluster_id</span> <span class="op">&lt;-</span> <span class="va">cluster_ids</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="co"># Check if this cluster ID exists in final_annotations names</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">cluster_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">final_annotations</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">annotation_map</span><span class="op">[</span><span class="va">cluster_id</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">final_annotations</span><span class="op">[</span><span class="va">cluster_id</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># For any remaining unmapped clusters, try to infer the mapping</span></span>
<span><span class="va">unmapped</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">annotation_map</span><span class="op">)</span> <span class="op">|</span> <span class="va">annotation_map</span> <span class="op">==</span> <span class="st">""</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">unmapped</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">unmapped_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">annotation_map</span><span class="op">)</span><span class="op">[</span><span class="va">unmapped</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Unmapped cluster IDs:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">unmapped_ids</span>, collapse<span class="op">=</span><span class="st">", "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># If we have the same number of unmapped clusters as remaining annotations,</span></span>
<span>  <span class="co"># we can try to assign them in order</span></span>
<span>  <span class="va">remaining_annotations</span> <span class="op">&lt;-</span> <span class="va">final_annotations</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">final_annotations</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">annotation_map</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="va">unmapped</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">remaining_annotations</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">unmapped_ids</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">unmapped_ids</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">annotation_map</span><span class="op">[</span><span class="va">unmapped_ids</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">remaining_annotations</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co"># If we can't map directly, assign "Unknown" to unmapped clusters</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">id</span> <span class="kw">in</span> <span class="va">unmapped_ids</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">annotation_map</span><span class="op">[</span><span class="va">id</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Unknown"</span>, <span class="va">id</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Final annotation map:\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">annotation_map</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add consensus annotations to Seurat object</span></span>
<span><span class="va">seurat_obj</span><span class="op">$</span><span class="va">cell_type_consensus</span> <span class="op">&lt;-</span> <span class="fu">plyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/mapvalues.html" class="external-link">mapvalues</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://satijalab.github.io/seurat-object/reference/Idents.html" class="external-link">Idents</a></span><span class="op">(</span><span class="va">seurat_obj</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">annotation_map</span><span class="op">)</span>,</span>
<span>  to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">annotation_map</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Verify the annotations were added correctly</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">seurat_obj</span><span class="op">$</span><span class="va">cell_type_consensus</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://satijalab.github.io/seurat-object/reference/Idents.html" class="external-link">Idents</a></span><span class="op">(</span><span class="va">seurat_obj</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract consensus metrics from the consensus results</span></span>
<span><span class="co"># Check if consensus_results has the expected structure</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">consensus_results</span><span class="op">$</span><span class="va">initial_results</span><span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span>    <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">consensus_results</span><span class="op">$</span><span class="va">initial_results</span><span class="op">$</span><span class="va">consensus_results</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Get consensus metrics</span></span>
<span>  <span class="va">consensus_metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">consensus_results</span><span class="op">$</span><span class="va">initial_results</span><span class="op">$</span><span class="va">consensus_results</span><span class="op">)</span>,</span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">cluster_id</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">metrics</span> <span class="op">&lt;-</span> <span class="va">consensus_results</span><span class="op">$</span><span class="va">initial_results</span><span class="op">$</span><span class="va">consensus_results</span><span class="op">[[</span><span class="va">cluster_id</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        cluster <span class="op">=</span> <span class="va">cluster_id</span>,</span>
<span>        consensus_proportion <span class="op">=</span> <span class="va">metrics</span><span class="op">$</span><span class="va">consensus_proportion</span>,</span>
<span>        entropy <span class="op">=</span> <span class="va">metrics</span><span class="op">$</span><span class="va">entropy</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Convert to data frame for easier handling</span></span>
<span>  <span class="va">metrics_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">consensus_metrics</span>, <span class="va">data.frame</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Create a mapping for consensus proportion</span></span>
<span>  <span class="va">proportion_map</span> <span class="op">&lt;-</span> <span class="va">metrics_df</span><span class="op">$</span><span class="va">consensus_proportion</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">proportion_map</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">metrics_df</span><span class="op">$</span><span class="va">cluster</span></span>
<span></span>
<span>  <span class="co"># Print the proportion map for debugging</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Consensus proportion map:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">proportion_map</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Create a mapping for entropy</span></span>
<span>  <span class="va">entropy_map</span> <span class="op">&lt;-</span> <span class="va">metrics_df</span><span class="op">$</span><span class="va">entropy</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">entropy_map</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">metrics_df</span><span class="op">$</span><span class="va">cluster</span></span>
<span></span>
<span>  <span class="co"># Print the entropy map for debugging</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Entropy map:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">entropy_map</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Add consensus proportion to Seurat object</span></span>
<span>  <span class="co"># First check if all cluster IDs are in the proportion map</span></span>
<span>  <span class="va">missing_clusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">cluster_ids</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">proportion_map</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">missing_clusters</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Warning: Some clusters are missing from proportion map:"</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">missing_clusters</span>, collapse<span class="op">=</span><span class="st">", "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>    <span class="co"># Add default values for missing clusters</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">cluster</span> <span class="kw">in</span> <span class="va">missing_clusters</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">proportion_map</span><span class="op">[</span><span class="va">cluster</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1.0</span>  <span class="co"># Default to perfect consensus</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">seurat_obj</span><span class="op">$</span><span class="va">consensus_proportion</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu">plyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/mapvalues.html" class="external-link">mapvalues</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://satijalab.github.io/seurat-object/reference/Idents.html" class="external-link">Idents</a></span><span class="op">(</span><span class="va">seurat_obj</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">proportion_map</span><span class="op">)</span>,</span>
<span>    to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">proportion_map</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Add entropy to Seurat object</span></span>
<span>  <span class="co"># First check if all cluster IDs are in the entropy map</span></span>
<span>  <span class="va">missing_clusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">cluster_ids</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">entropy_map</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">missing_clusters</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Warning: Some clusters are missing from entropy map:"</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">missing_clusters</span>, collapse<span class="op">=</span><span class="st">", "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>    <span class="co"># Add default values for missing clusters</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">cluster</span> <span class="kw">in</span> <span class="va">missing_clusters</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">entropy_map</span><span class="op">[</span><span class="va">cluster</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.0</span>  <span class="co"># Default to no uncertainty</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">seurat_obj</span><span class="op">$</span><span class="va">entropy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu">plyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/mapvalues.html" class="external-link">mapvalues</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://satijalab.github.io/seurat-object/reference/Idents.html" class="external-link">Idents</a></span><span class="op">(</span><span class="va">seurat_obj</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">entropy_map</span><span class="op">)</span>,</span>
<span>    to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">entropy_map</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Verify metrics were added correctly</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">seurat_obj</span><span class="op">$</span><span class="va">consensus_proportion</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">seurat_obj</span><span class="op">$</span><span class="va">entropy</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="co"># If the expected structure is not found, create dummy metrics</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"Could not find consensus metrics in the results. Creating dummy metrics for visualization purposes."</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Create dummy metrics</span></span>
<span>  <span class="va">seurat_obj</span><span class="op">$</span><span class="va">consensus_proportion</span> <span class="op">&lt;-</span> <span class="fl">1.0</span>  <span class="co"># Perfect consensus</span></span>
<span>  <span class="va">seurat_obj</span><span class="op">$</span><span class="va">entropy</span> <span class="op">&lt;-</span> <span class="fl">0.0</span>  <span class="co"># No uncertainty</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="basic-visualization-with-seurat">Basic Visualization with Seurat<a class="anchor" aria-label="anchor" href="#basic-visualization-with-seurat"></a>
</h4>
<div class="section level5">
<h5 id="cell-type-annotations">Cell Type Annotations<a class="anchor" aria-label="anchor" href="#cell-type-annotations"></a>
</h5>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Basic cell type visualization</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html" class="external-link">DimPlot</a></span><span class="op">(</span><span class="va">seurat_obj</span>,</span>
<span>              group.by <span class="op">=</span> <span class="st">"cell_type_consensus"</span>,</span>
<span>              label <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>              repel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Cell Type Annotations"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="consensus-proportion">Consensus Proportion<a class="anchor" aria-label="anchor" href="#consensus-proportion"></a>
</h5>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualize consensus proportion</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FeaturePlot.html" class="external-link">FeaturePlot</a></span><span class="op">(</span><span class="va">seurat_obj</span>,</span>
<span>                 features <span class="op">=</span> <span class="st">"consensus_proportion"</span>,</span>
<span>                 cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"yellow"</span>, <span class="st">"green"</span>, <span class="st">"blue"</span><span class="op">)</span>,</span>
<span>                 min.cutoff <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>                 max.cutoff <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Consensus Proportion"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="shannon-entropy">Shannon Entropy<a class="anchor" aria-label="anchor" href="#shannon-entropy"></a>
</h5>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualize Shannon entropy</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FeaturePlot.html" class="external-link">FeaturePlot</a></span><span class="op">(</span><span class="va">seurat_obj</span>,</span>
<span>                 features <span class="op">=</span> <span class="st">"entropy"</span>,  <span class="co"># Note: The column name is 'entropy', not 'shannon_entropy'</span></span>
<span>                 cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"orange"</span>, <span class="st">"yellow"</span><span class="op">)</span>,</span>
<span>                 min.cutoff <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                 max.cutoff <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_color_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"red"</span>, high <span class="op">=</span> <span class="st">"yellow"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Shannon Entropy"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p3</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="combined-visualization">Combined Visualization<a class="anchor" aria-label="anchor" href="#combined-visualization"></a>
</h5>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Combine all three visualizations</span></span>
<span><span class="va">p1</span> <span class="op">|</span> <span class="va">p2</span> <span class="op">|</span> <span class="va">p3</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="publication-ready-visualizations-with-scpubr">Publication-Ready Visualizations with SCpubr<a class="anchor" aria-label="anchor" href="#publication-ready-visualizations-with-scpubr"></a>
</h3>
<p>For publication-quality visualizations, we recommend using the SCpubr
package, which provides enhanced aesthetics for single-cell
visualizations. Below are several advanced visualization techniques that
can significantly improve the quality and interpretability of your
results.</p>
<blockquote>
<p><strong>Note:</strong> For a gallery of all visualization examples,
please see the <a href="visualization_gallery.html">Visualization
Gallery</a>.</p>
</blockquote>
<div class="section level4">
<h4 id="installing-and-loading-required-packages">Installing and Loading Required Packages<a class="anchor" aria-label="anchor" href="#installing-and-loading-required-packages"></a>
</h4>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install SCpubr if not already installed</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"SCpubr"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"enblacar/SCpubr"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Install other required packages</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"viridis"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"viridis"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"patchwork"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"patchwork"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"ggExtra"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"ggExtra"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Load required packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/enblacar/SCpubr/" class="external-link">SCpubr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/" class="external-link">viridis</a></span><span class="op">)</span>  <span class="co"># For color palettes</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span> <span class="co"># For combining plots</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/daattali/ggExtra" class="external-link">ggExtra</a></span><span class="op">)</span> <span class="co"># For marginal distributions</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="standardizing-cell-type-names">Standardizing Cell Type Names<a class="anchor" aria-label="anchor" href="#standardizing-cell-type-names"></a>
</h4>
<p>Before visualization, it’s important to standardize cell type names
to ensure consistency:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Standardize cell type names</span></span>
<span><span class="co"># Merge singular and plural forms</span></span>
<span><span class="va">seurat_obj</span><span class="op">$</span><span class="va">cell_type_consensus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"B cell$"</span>, <span class="st">"B cells"</span>, <span class="va">seurat_obj</span><span class="op">$</span><span class="va">cell_type_consensus</span><span class="op">)</span></span>
<span><span class="va">seurat_obj</span><span class="op">$</span><span class="va">cell_type_consensus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"T cell$"</span>, <span class="st">"T cells"</span>, <span class="va">seurat_obj</span><span class="op">$</span><span class="va">cell_type_consensus</span><span class="op">)</span></span>
<span><span class="va">seurat_obj</span><span class="op">$</span><span class="va">cell_type_consensus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"Mast cell"</span>, <span class="st">"Mast Cell"</span>, <span class="va">seurat_obj</span><span class="op">$</span><span class="va">cell_type_consensus</span><span class="op">)</span></span>
<span><span class="va">seurat_obj</span><span class="op">$</span><span class="va">cell_type_consensus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"Plasmacytoid Dendritic Cell$"</span>, <span class="st">"Plasmacytoid Dendritic Cells"</span>, <span class="va">seurat_obj</span><span class="op">$</span><span class="va">cell_type_consensus</span><span class="op">)</span></span>
<span><span class="va">seurat_obj</span><span class="op">$</span><span class="va">cell_type_consensus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"Natural Killer \\(NK\\) Cell"</span>, <span class="st">"Natural Killer Cell"</span>, <span class="va">seurat_obj</span><span class="op">$</span><span class="va">cell_type_consensus</span><span class="op">)</span></span>
<span><span class="va">seurat_obj</span><span class="op">$</span><span class="va">cell_type_consensus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"NK Cell"</span>, <span class="st">"Natural Killer Cell"</span>, <span class="va">seurat_obj</span><span class="op">$</span><span class="va">cell_type_consensus</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="creating-a-custom-color-palette">Creating a Custom Color Palette<a class="anchor" aria-label="anchor" href="#creating-a-custom-color-palette"></a>
</h4>
<p>Using a colorblind-friendly palette enhances the accessibility of
your visualizations:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a custom color palette that enhances cluster separation</span></span>
<span><span class="co"># Using a colorblind-friendly palette from viridis</span></span>
<span><span class="va">n_cell_types</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">seurat_obj</span><span class="op">$</span><span class="va">cell_type_consensus</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">custom_colors</span> <span class="op">&lt;-</span> <span class="fu">viridis</span><span class="fu">::</span><span class="fu">viridis</span><span class="op">(</span><span class="va">n_cell_types</span>, option <span class="op">=</span> <span class="st">"turbo"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">custom_colors</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">seurat_obj</span><span class="op">$</span><span class="va">cell_type_consensus</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="enhanced-cell-type-umap-visualization">Enhanced Cell Type UMAP Visualization<a class="anchor" aria-label="anchor" href="#enhanced-cell-type-umap-visualization"></a>
</h4>
<p>This enhanced visualization includes cell borders, optimized label
placement, and improved aesthetics:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Enhanced UMAP visualization with cell borders and optimized styling</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">SCpubr</span><span class="fu">::</span><span class="fu">do_DimPlot</span><span class="op">(</span>sample <span class="op">=</span> <span class="va">seurat_obj</span>,</span>
<span>                   group.by <span class="op">=</span> <span class="st">"cell_type_consensus"</span>,</span>
<span>                   label <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                   label.box <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                   label.size <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                   repel <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                   legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>                   pt.size <span class="op">=</span> <span class="fl">1.2</span>,</span>
<span>                   plot_cell_borders <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                   border.size <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>                   border.color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>                   colors.use <span class="op">=</span> <span class="va">custom_colors</span>,</span>
<span>                   font.size <span class="op">=</span> <span class="fl">14</span>,</span>
<span>                   plot.title <span class="op">=</span> <span class="st">"Cell Types"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span>, margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fl">1</span>, t <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span></span></code></pre></div>
<p><strong>Example Output:</strong></p>
<p><img src="figures/png/fig1_cell_types.png" alt="Enhanced Cell Type UMAP" width="90%"></p>
<p>This visualization clearly shows distinct cell type clusters with
optimized labels and borders, making it easy to identify different cell
populations.</p>
</div>
<div class="section level4">
<h4 id="umap-with-density-contours">UMAP with Density Contours<a class="anchor" aria-label="anchor" href="#umap-with-density-contours"></a>
</h4>
<p>Adding density contours helps to better visualize cluster
boundaries:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 2. UMAP with density contours to better show clustering patterns</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">SCpubr</span><span class="fu">::</span><span class="fu">do_DimPlot</span><span class="op">(</span>sample <span class="op">=</span> <span class="va">seurat_obj</span>,</span>
<span>                   group.by <span class="op">=</span> <span class="st">"cell_type_consensus"</span>,</span>
<span>                   label <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                   label.box <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                   repel <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                   legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>                   pt.size <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span>                   plot_density_contour <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                   contour.color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>                   <span class="co"># Place contours below labels for better visibility</span></span>
<span>                   contour.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>                   colors.use <span class="op">=</span> <span class="va">custom_colors</span>,</span>
<span>                   font.size <span class="op">=</span> <span class="fl">14</span>,</span>
<span>                   plot.title <span class="op">=</span> <span class="st">"Cell Type Clusters with Density Contours"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span>, margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fl">1</span>, t <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span></span></code></pre></div>
<p><strong>Example Output:</strong></p>
<p><img src="figures/png/fig2_density_contours.png" alt="UMAP with Density Contours" width="90%"></p>
<p>Density contours highlight the concentration of cells within each
cluster, providing additional information about cluster density and
boundaries.</p>
</div>
<div class="section level4">
<h4 id="highlighting-controversial-clusters">Highlighting Controversial Clusters<a class="anchor" aria-label="anchor" href="#highlighting-controversial-clusters"></a>
</h4>
<p>Visualizing controversial clusters (those with low consensus or high
entropy) can provide valuable insights:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a controversial clusters column (low consensus or high entropy)</span></span>
<span><span class="va">seurat_obj</span><span class="op">$</span><span class="va">controversial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">seurat_obj</span><span class="op">$</span><span class="va">consensus_proportion</span> <span class="op">&lt;</span> <span class="fl">0.6</span> <span class="op">|</span> <span class="va">seurat_obj</span><span class="op">$</span><span class="va">entropy</span> <span class="op">&gt;</span> <span class="fl">0.5</span>,</span>
<span>                           <span class="st">"Controversial"</span>, <span class="st">"Consensus"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Controversial clusters visualization</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu">SCpubr</span><span class="fu">::</span><span class="fu">do_DimPlot</span><span class="op">(</span>sample <span class="op">=</span> <span class="va">seurat_obj</span>,</span>
<span>                   group.by <span class="op">=</span> <span class="st">"controversial"</span>,</span>
<span>                   label <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                   legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>                   pt.size <span class="op">=</span> <span class="fl">1.2</span>,</span>
<span>                   colors.use <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Controversial"</span> <span class="op">=</span> <span class="st">"#E41A1C"</span>, <span class="st">"Consensus"</span> <span class="op">=</span> <span class="st">"#4DAF4A"</span><span class="op">)</span>,</span>
<span>                   font.size <span class="op">=</span> <span class="fl">14</span>,</span>
<span>                   plot.title <span class="op">=</span> <span class="st">"Controversial vs. Consensus Clusters"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span>, margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fl">1</span>, t <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p3</span></span></code></pre></div>
<p><strong>Example Output:</strong></p>
<p><img src="figures/png/fig3_controversial_clusters.png" alt="Controversial Clusters" width="90%"></p>
<p>This visualization highlights clusters with low consensus or high
entropy (red), which may require further investigation or
validation.</p>
</div>
<div class="section level4">
<h4 id="umap-with-marginal-distributions">UMAP with Marginal Distributions<a class="anchor" aria-label="anchor" href="#umap-with-marginal-distributions"></a>
</h4>
<p>Adding marginal distributions can help visualize the overall
distribution of cells:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 4. UMAP with marginal distributions</span></span>
<span><span class="co"># Using basic ggplot2 to create UMAP plot, then adding marginal distributions</span></span>
<span><span class="va">p4_base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>UMAP_1 <span class="op">=</span> <span class="fu"><a href="https://satijalab.github.io/seurat-object/reference/Embeddings.html" class="external-link">Embeddings</a></span><span class="op">(</span><span class="va">seurat_obj</span>, <span class="st">"umap"</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>                            UMAP_2 <span class="op">=</span> <span class="fu"><a href="https://satijalab.github.io/seurat-object/reference/Embeddings.html" class="external-link">Embeddings</a></span><span class="op">(</span><span class="va">seurat_obj</span>, <span class="st">"umap"</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,</span>
<span>                            cell_type <span class="op">=</span> <span class="va">seurat_obj</span><span class="op">$</span><span class="va">cell_type_consensus</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">UMAP_1</span>, y <span class="op">=</span> <span class="va">UMAP_2</span>, color <span class="op">=</span> <span class="va">cell_type</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">custom_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Cell Types with Marginal Distributions"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>        legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add marginal distributions, controlling the size</span></span>
<span><span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu">ggExtra</span><span class="fu">::</span><span class="fu">ggMarginal</span><span class="op">(</span><span class="va">p4_base</span>, type <span class="op">=</span> <span class="st">"density"</span>,</span>
<span>                         groupColour <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                         groupFill <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                         size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>  <span class="co"># Control the size of marginal plots</span></span>
<span></span>
<span><span class="va">p4</span></span></code></pre></div>
<p><strong>Example Output:</strong></p>
<p><img src="figures/png/fig4_marginal_distributions.png" alt="UMAP with Marginal Distributions" width="90%"></p>
<p>Marginal distributions show the density of cells along each axis,
providing additional context about the overall distribution of cells in
the UMAP space.</p>
</div>
<div class="section level4">
<h4 id="enhanced-consensus-proportion-visualization">Enhanced Consensus Proportion Visualization<a class="anchor" aria-label="anchor" href="#enhanced-consensus-proportion-visualization"></a>
</h4>
<p>Improved visualization of consensus proportion with density
contours:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 5. Enhanced consensus proportion visualization</span></span>
<span><span class="va">p5</span> <span class="op">&lt;-</span> <span class="fu">SCpubr</span><span class="fu">::</span><span class="fu">do_FeaturePlot</span><span class="op">(</span>sample <span class="op">=</span> <span class="va">seurat_obj</span>,</span>
<span>                             features <span class="op">=</span> <span class="st">"consensus_proportion"</span>,</span>
<span>                             order <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                             pt.size <span class="op">=</span> <span class="fl">1.2</span>,</span>
<span>                             enforce_symmetry <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                             legend.title <span class="op">=</span> <span class="st">"Consensus\nProportion"</span>,</span>
<span>                             plot.title <span class="op">=</span> <span class="st">"Annotation Confidence"</span>,</span>
<span>                             sequential.palette <span class="op">=</span> <span class="st">"YlGnBu"</span>,</span>
<span>                             sequential.direction <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                             min.cutoff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">seurat_obj</span><span class="op">$</span><span class="va">consensus_proportion</span><span class="op">)</span>,</span>
<span>                             max.cutoff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">seurat_obj</span><span class="op">$</span><span class="va">consensus_proportion</span><span class="op">)</span>,</span>
<span>                             na.value <span class="op">=</span> <span class="st">"lightgrey"</span>,</span>
<span>                             plot_density_contour <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                             contour.color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>                             contour.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>                             font.size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span>, margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fl">1</span>, t <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p5</span></span></code></pre></div>
<p><strong>Example Output:</strong></p>
<p><img src="figures/png/fig5_consensus_proportion.png" alt="Consensus Proportion" width="90%"></p>
<p>This visualization shows the consensus proportion for each cell, with
higher values (blue) indicating greater agreement among models about the
cell type annotation.</p>
</div>
<div class="section level4">
<h4 id="enhanced-entropy-visualization">Enhanced Entropy Visualization<a class="anchor" aria-label="anchor" href="#enhanced-entropy-visualization"></a>
</h4>
<p>Improved visualization of entropy with density contours:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 6. Enhanced entropy visualization</span></span>
<span><span class="va">p6</span> <span class="op">&lt;-</span> <span class="fu">SCpubr</span><span class="fu">::</span><span class="fu">do_FeaturePlot</span><span class="op">(</span>sample <span class="op">=</span> <span class="va">seurat_obj</span>,</span>
<span>                             features <span class="op">=</span> <span class="st">"entropy"</span>,</span>
<span>                             order <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                             pt.size <span class="op">=</span> <span class="fl">1.2</span>,</span>
<span>                             enforce_symmetry <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                             legend.title <span class="op">=</span> <span class="st">"Shannon\nEntropy"</span>,</span>
<span>                             plot.title <span class="op">=</span> <span class="st">"Annotation Uncertainty"</span>,</span>
<span>                             sequential.palette <span class="op">=</span> <span class="st">"OrRd"</span>,</span>
<span>                             sequential.direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>                             min.cutoff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">seurat_obj</span><span class="op">$</span><span class="va">entropy</span><span class="op">)</span>,</span>
<span>                             max.cutoff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">seurat_obj</span><span class="op">$</span><span class="va">entropy</span><span class="op">)</span>,</span>
<span>                             na.value <span class="op">=</span> <span class="st">"lightgrey"</span>,</span>
<span>                             plot_density_contour <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                             contour.color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>                             contour.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>                             font.size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span>, margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fl">1</span>, t <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p6</span></span></code></pre></div>
<p><strong>Example Output:</strong></p>
<p><img src="figures/png/fig6_entropy.png" alt="Shannon Entropy" width="90%"></p>
<p>This visualization shows the entropy for each cell, with higher
values (yellow) indicating greater uncertainty in the cell type
annotation. Lower entropy (red) suggests more confident annotations.</p>
</div>
<div class="section level4">
<h4 id="cell-types-with-consensus-proportion">Cell Types with Consensus Proportion<a class="anchor" aria-label="anchor" href="#cell-types-with-consensus-proportion"></a>
</h4>
<p>Visualizing cell types with consensus proportion provides a combined
view:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 7. Group by cell type but show consensus proportion with group.by.cell_borders</span></span>
<span><span class="va">p7</span> <span class="op">&lt;-</span> <span class="fu">SCpubr</span><span class="fu">::</span><span class="fu">do_FeaturePlot</span><span class="op">(</span>sample <span class="op">=</span> <span class="va">seurat_obj</span>,</span>
<span>                             features <span class="op">=</span> <span class="st">"consensus_proportion"</span>,</span>
<span>                             group.by <span class="op">=</span> <span class="st">"cell_type_consensus"</span>,</span>
<span>                             group.by.cell_borders <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                             group.by.cell_borders.alpha <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>                             group.by.show.dots <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                             group.by.dot.size <span class="op">=</span> <span class="fl">8</span>,</span>
<span>                             group.by.colors.use <span class="op">=</span> <span class="va">custom_colors</span>,</span>
<span>                             order <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                             pt.size <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span>                             sequential.palette <span class="op">=</span> <span class="st">"YlGnBu"</span>,</span>
<span>                             sequential.direction <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                             legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>                             legend.title <span class="op">=</span> <span class="st">"Consensus\nProportion"</span>,</span>
<span>                             plot.title <span class="op">=</span> <span class="st">"Cell Types with Consensus Proportion"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>        legend.key.size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p7</span></span></code></pre></div>
<p><strong>Example Output:</strong></p>
<p><img src="figures/png/fig7_cell_types_with_consensus.png" alt="Cell Types with Consensus Proportion" width="90%"></p>
<p>This visualization combines cell type information with consensus
proportion, showing both the cell type clusters and the confidence in
each annotation. Cell type boundaries are shown with colored outlines,
while the color intensity represents the consensus proportion.</p>
</div>
<div class="section level4">
<h4 id="uncertainty-metrics-violin-plots">Uncertainty Metrics Violin Plots<a class="anchor" aria-label="anchor" href="#uncertainty-metrics-violin-plots"></a>
</h4>
<p>Violin plots can help visualize the distribution of uncertainty
metrics by cell type:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 8. Violin plots of uncertainty metrics by cell type</span></span>
<span><span class="va">p8a</span> <span class="op">&lt;-</span> <span class="fu">SCpubr</span><span class="fu">::</span><span class="fu">do_ViolinPlot</span><span class="op">(</span>sample <span class="op">=</span> <span class="va">seurat_obj</span>,</span>
<span>                            features <span class="op">=</span> <span class="st">"consensus_proportion"</span>,</span>
<span>                            group.by <span class="op">=</span> <span class="st">"cell_type_consensus"</span>,</span>
<span>                            flip <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                            colors.use <span class="op">=</span> <span class="va">custom_colors</span>,</span>
<span>                            legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>                            legend.title <span class="op">=</span> <span class="st">"Cell Type"</span>,</span>
<span>                            plot.title <span class="op">=</span> <span class="st">"Consensus Proportion by Cell Type"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>        legend.key.size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p8b</span> <span class="op">&lt;-</span> <span class="fu">SCpubr</span><span class="fu">::</span><span class="fu">do_ViolinPlot</span><span class="op">(</span>sample <span class="op">=</span> <span class="va">seurat_obj</span>,</span>
<span>                            features <span class="op">=</span> <span class="st">"entropy"</span>,</span>
<span>                            group.by <span class="op">=</span> <span class="st">"cell_type_consensus"</span>,</span>
<span>                            flip <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                            colors.use <span class="op">=</span> <span class="va">custom_colors</span>,</span>
<span>                            legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>                            legend.title <span class="op">=</span> <span class="st">"Cell Type"</span>,</span>
<span>                            plot.title <span class="op">=</span> <span class="st">"Entropy by Cell Type"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>        legend.key.size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine violin plots</span></span>
<span><span class="va">p8</span> <span class="op">&lt;-</span> <span class="va">p8a</span> <span class="op">/</span> <span class="va">p8b</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p8</span></span></code></pre></div>
<p><strong>Example Output:</strong></p>
<p><img src="figures/png/fig8_uncertainty_violins.png" alt="Uncertainty Metrics Violin Plots" width="90%"></p>
<p>Violin plots show the distribution of consensus proportion and
entropy values for each cell type, allowing for easy comparison of
annotation confidence across different cell populations.</p>
</div>
<div class="section level4">
<h4 id="combined-dashboard">Combined Dashboard<a class="anchor" aria-label="anchor" href="#combined-dashboard"></a>
</h4>
<p>Creating a dashboard with multiple visualizations provides a
comprehensive view:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 9. Combined visualization dashboard</span></span>
<span><span class="co"># Create a simplified dashboard with the main visualizations</span></span>
<span><span class="va">simplified_dashboard</span> <span class="op">&lt;-</span> <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span></span>
<span>  <span class="va">p1</span>, <span class="va">p5</span>, <span class="va">p6</span>,</span>
<span>  ncol <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span><span class="op">)</span>,</span>
<span>  label_size <span class="op">=</span> <span class="fl">18</span>,</span>
<span>  rel_widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>  <span class="co"># Give cell type plot more space</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">simplified_dashboard</span></span></code></pre></div>
<p><strong>Example Output:</strong></p>
<p><img src="figures/png/fig9_dashboard.png" alt="Combined Dashboard" width="90%"></p>
<p>This dashboard combines multiple visualizations into a single figure,
providing a comprehensive view of cell type annotations and uncertainty
metrics. The panels are labeled for easy reference in publications.</p>
</div>
<div class="section level4">
<h4 id="high-resolution-publication-figure">High-Resolution Publication Figure<a class="anchor" aria-label="anchor" href="#high-resolution-publication-figure"></a>
</h4>
<p>Creating a high-resolution figure for publication:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 10. High-resolution figure for publication</span></span>
<span><span class="va">p1_pub</span> <span class="op">&lt;-</span> <span class="fu">SCpubr</span><span class="fu">::</span><span class="fu">do_DimPlot</span><span class="op">(</span>sample <span class="op">=</span> <span class="va">seurat_obj</span>,</span>
<span>                         group.by <span class="op">=</span> <span class="st">"cell_type_consensus"</span>,</span>
<span>                         label <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                         label.box <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                         label.size <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                         repel <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                         legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>                         pt.size <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span>                         plot_cell_borders <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                         border.size <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span>                         colors.use <span class="op">=</span> <span class="va">custom_colors</span>,</span>
<span>                         font.size <span class="op">=</span> <span class="fl">14</span>,</span>
<span>                         plot.title <span class="op">=</span> <span class="st">"Cell Types"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span>, margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fl">1</span>, t <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>        legend.key.size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1_pub</span></span></code></pre></div>
<p><strong>Example Output:</strong></p>
<p><img src="figures/png/fig10_publication.png" alt="High-Resolution Publication Figure" width="90%"></p>
<p>This high-resolution figure is specifically designed for publication,
with optimized dimensions, font sizes, and visual elements. The
increased height provides more space for clear visualization of cell
type clusters and labels.</p>
</div>
<div class="section level4">
<h4 id="saving-visualizations">Saving Visualizations<a class="anchor" aria-label="anchor" href="#saving-visualizations"></a>
</h4>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a directory to save all visualizations</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">"mLLMCelltype_visualizations"</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save individual plots</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="st">"mLLMCelltype_visualizations/1_enhanced_cell_type_umap.pdf"</span>, plot <span class="op">=</span> <span class="va">p1</span>, width <span class="op">=</span> <span class="fl">10</span>, height <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="st">"mLLMCelltype_visualizations/2_density_contour_umap.pdf"</span>, plot <span class="op">=</span> <span class="va">p2</span>, width <span class="op">=</span> <span class="fl">10</span>, height <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="st">"mLLMCelltype_visualizations/3_controversial_clusters.pdf"</span>, plot <span class="op">=</span> <span class="va">p3</span>, width <span class="op">=</span> <span class="fl">10</span>, height <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="st">"mLLMCelltype_visualizations/5_enhanced_consensus_proportion.pdf"</span>, plot <span class="op">=</span> <span class="va">p5</span>, width <span class="op">=</span> <span class="fl">10</span>, height <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="st">"mLLMCelltype_visualizations/6_enhanced_entropy.pdf"</span>, plot <span class="op">=</span> <span class="va">p6</span>, width <span class="op">=</span> <span class="fl">10</span>, height <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="st">"mLLMCelltype_visualizations/7_cell_type_with_consensus.pdf"</span>, plot <span class="op">=</span> <span class="va">p7</span>, width <span class="op">=</span> <span class="fl">12</span>, height <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="st">"mLLMCelltype_visualizations/8_uncertainty_violins.pdf"</span>, plot <span class="op">=</span> <span class="va">p8</span>, width <span class="op">=</span> <span class="fl">16</span>, height <span class="op">=</span> <span class="fl">14</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="st">"mLLMCelltype_visualizations/9_combined_dashboard.pdf"</span>, plot <span class="op">=</span> <span class="va">simplified_dashboard</span>, width <span class="op">=</span> <span class="fl">24</span>, height <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="st">"mLLMCelltype_visualizations/10_publication_figure.pdf"</span>, plot <span class="op">=</span> <span class="va">p1_pub</span>, width <span class="op">=</span> <span class="fl">18</span>, height <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="additional-advanced-visualization-techniques">Additional Advanced Visualization Techniques<a class="anchor" aria-label="anchor" href="#additional-advanced-visualization-techniques"></a>
</h3>
<div class="section level4">
<h4 id="model-agreement-visualization">Model Agreement Visualization<a class="anchor" aria-label="anchor" href="#model-agreement-visualization"></a>
</h4>
<p>You can visualize how different models agree or disagree with the
consensus:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Assuming you have individual model results in the Seurat object</span></span>
<span><span class="co"># Create a function to calculate agreement with consensus</span></span>
<span><span class="va">calculate_agreement</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">seurat_obj</span>, <span class="va">model_column</span>, <span class="va">consensus_column</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">seurat_obj</span><span class="op">$</span><span class="va">agreement</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span></span>
<span>    <span class="va">seurat_obj</span><span class="op">[[</span><span class="va">model_column</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="va">seurat_obj</span><span class="op">[[</span><span class="va">consensus_column</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    <span class="st">"Agrees with consensus"</span>,</span>
<span>    <span class="st">"Disagrees with consensus"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">seurat_obj</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Apply to each model</span></span>
<span><span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"claude_3_7_sonnet"</span>, <span class="st">"gpt_4o"</span>, <span class="st">"gemini_1_5_pro"</span><span class="op">)</span></span>
<span><span class="va">plot_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">model</span> <span class="kw">in</span> <span class="va">models</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">column_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"cell_type_"</span>, <span class="va">model</span><span class="op">)</span></span>
<span>  <span class="va">temp_obj</span> <span class="op">&lt;-</span> <span class="fu">calculate_agreement</span><span class="op">(</span><span class="va">seurat_obj</span>, <span class="va">column_name</span>, <span class="st">"cell_type_consensus"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Create plot with SCpubr</span></span>
<span>  <span class="va">p_temp</span> <span class="op">&lt;-</span> <span class="fu">SCpubr</span><span class="fu">::</span><span class="fu">do_DimPlot</span><span class="op">(</span><span class="va">temp_obj</span>,</span>
<span>                              group.by <span class="op">=</span> <span class="st">"agreement"</span>,</span>
<span>                              colors.use <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Agrees with consensus"</span> <span class="op">=</span> <span class="st">"darkgreen"</span>,</span>
<span>                                            <span class="st">"Disagrees with consensus"</span> <span class="op">=</span> <span class="st">"darkred"</span><span class="op">)</span>,</span>
<span>                              pt.size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Add title using ggplot2</span></span>
<span>  <span class="va">plot_list</span><span class="op">[[</span><span class="va">model</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p_temp</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">model</span>, <span class="st">" Agreement"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Combine all agreement plots</span></span>
<span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html" class="external-link">wrap_plots</a></span><span class="op">(</span><span class="va">plot_list</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="heatmap-of-model-predictions">Heatmap of Model Predictions<a class="anchor" aria-label="anchor" href="#heatmap-of-model-predictions"></a>
</h4>
<p>Create a heatmap to visualize all model predictions for each
cluster:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">pheatmap</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a matrix of model predictions for each cluster</span></span>
<span><span class="va">create_prediction_matrix</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">consensus_results</span>, <span class="va">models</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n_clusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">consensus_results</span><span class="op">$</span><span class="va">final_annotations</span><span class="op">)</span></span>
<span>  <span class="va">prediction_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">n_clusters</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">prediction_matrix</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Cluster_"</span>, <span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="va">n_clusters</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">prediction_matrix</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">models</span></span>
<span></span>
<span>  <span class="co"># Extract individual model predictions from initial_results</span></span>
<span>  <span class="va">initial_predictions</span> <span class="op">&lt;-</span> <span class="va">consensus_results</span><span class="op">$</span><span class="va">initial_results</span><span class="op">$</span><span class="va">individual_predictions</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">model</span> <span class="op">&lt;-</span> <span class="va">models</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">model</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">initial_predictions</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">predictions</span> <span class="op">&lt;-</span> <span class="va">initial_predictions</span><span class="op">[[</span><span class="va">model</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="co"># Convert predictions to a vector if it's a list</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">is.list</a></span><span class="op">(</span><span class="va">predictions</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">pred_vector</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">predictions</span><span class="op">)</span></span>
<span>        <span class="va">prediction_matrix</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pred_vector</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="va">prediction_matrix</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">predictions</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">prediction_matrix</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Convert cell type names to numeric codes for visualization</span></span>
<span><span class="va">encode_cell_types</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prediction_matrix</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">unique_types</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">prediction_matrix</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># Remove NA values before creating mapping</span></span>
<span>  <span class="va">unique_types</span> <span class="op">&lt;-</span> <span class="va">unique_types</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">unique_types</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">type_mapping</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">unique_types</span><span class="op">)</span>, <span class="va">unique_types</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">encoded_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">prediction_matrix</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">prediction_matrix</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">encoded_matrix</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">prediction_matrix</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">encoded_matrix</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">prediction_matrix</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">prediction_matrix</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">prediction_matrix</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">prediction_matrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">encoded_matrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">type_mapping</span><span class="op">[</span><span class="va">prediction_matrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>matrix <span class="op">=</span> <span class="va">encoded_matrix</span>, mapping <span class="op">=</span> <span class="va">type_mapping</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Create and plot the heatmap</span></span>
<span><span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"claude-3-7-sonnet-20250219"</span>, <span class="st">"gpt-4o"</span>, <span class="st">"gemini-1.5-pro"</span><span class="op">)</span></span>
<span><span class="va">prediction_matrix</span> <span class="op">&lt;-</span> <span class="fu">create_prediction_matrix</span><span class="op">(</span><span class="va">consensus_results</span>, <span class="va">models</span><span class="op">)</span></span>
<span><span class="va">encoded_data</span> <span class="op">&lt;-</span> <span class="fu">encode_cell_types</span><span class="op">(</span><span class="va">prediction_matrix</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract metrics for annotation row</span></span>
<span><span class="va">metrics_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">consensus_metrics</span>, <span class="va">data.frame</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add consensus and uncertainty metrics as annotations</span></span>
<span><span class="va">annotation_row</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  Consensus <span class="op">=</span> <span class="va">consensus_results</span><span class="op">$</span><span class="va">final_annotations</span>,</span>
<span>  Proportion <span class="op">=</span> <span class="va">metrics_df</span><span class="op">$</span><span class="va">consensus_proportion</span>,</span>
<span>  Entropy <span class="op">=</span> <span class="va">metrics_df</span><span class="op">$</span><span class="va">entropy</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">annotation_row</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">prediction_matrix</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create color scales</span></span>
<span><span class="va">n_types</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">encoded_data</span><span class="op">$</span><span class="va">mapping</span><span class="op">)</span></span>
<span><span class="va">cell_type_colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">rainbow</a></span><span class="op">(</span><span class="va">n_types</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="va">n_types</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">cell_type_colors</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_types</span></span>
<span></span>
<span><span class="va">proportion_colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"yellow"</span>, <span class="st">"green"</span>, <span class="st">"blue"</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">entropy_colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"orange"</span>, <span class="st">"yellow"</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="va">annotation_colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  Proportion <span class="op">=</span> <span class="va">proportion_colors</span>,</span>
<span>  Entropy <span class="op">=</span> <span class="va">entropy_colors</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot heatmap</span></span>
<span><span class="fu">pheatmap</span><span class="op">(</span></span>
<span>  <span class="va">encoded_data</span><span class="op">$</span><span class="va">matrix</span>,</span>
<span>  cluster_rows <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  cluster_cols <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  annotation_row <span class="op">=</span> <span class="va">annotation_row</span>,</span>
<span>  annotation_colors <span class="op">=</span> <span class="va">annotation_colors</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"Model Predictions by Cluster"</span>,</span>
<span>  fontsize <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  cellwidth <span class="op">=</span> <span class="fl">30</span>,</span>
<span>  cellheight <span class="op">=</span> <span class="fl">30</span>,</span>
<span>  legend <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  display_numbers <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  number_format <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">encoded_data</span><span class="op">$</span><span class="va">mapping</span><span class="op">)</span><span class="op">[</span><span class="va">encoded_data</span><span class="op">$</span><span class="va">mapping</span> <span class="op">==</span> <span class="va">x</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="visualizing-discussion-logs">Visualizing Discussion Logs<a class="anchor" aria-label="anchor" href="#visualizing-discussion-logs"></a>
</h3>
<p>The discussion logs contain valuable information about the reasoning
process. Here’s how to visualize key aspects:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://juliasilge.github.io/tidytext/" class="external-link">tidytext</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://blog.fellstat.com/?cat=11" class="external-link">wordcloud</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract discussion text for a specific cluster</span></span>
<span><span class="va">extract_discussion_text</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">consensus_results</span>, <span class="va">cluster_id</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">discussion_logs</span> <span class="op">&lt;-</span> <span class="va">consensus_results</span><span class="op">$</span><span class="va">discussion_logs</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">discussion_logs</span><span class="op">)</span> <span class="op">||</span> <span class="op">!</span><span class="va">cluster_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">discussion_logs</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Extract text from discussion logs</span></span>
<span>  <span class="va">discussion_log</span> <span class="op">&lt;-</span> <span class="va">discussion_logs</span><span class="op">[[</span><span class="va">cluster_id</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Combine all text from all rounds</span></span>
<span>  <span class="va">all_text</span> <span class="op">&lt;-</span> <span class="st">""</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">discussion_log</span><span class="op">$</span><span class="va">rounds</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">round</span> <span class="kw">in</span> <span class="va">discussion_log</span><span class="op">$</span><span class="va">rounds</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">round</span><span class="op">$</span><span class="va">responses</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">for</span> <span class="op">(</span><span class="va">model_name</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">round</span><span class="op">$</span><span class="va">responses</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">response</span> <span class="op">&lt;-</span> <span class="va">round</span><span class="op">$</span><span class="va">responses</span><span class="op">[[</span><span class="va">model_name</span><span class="op">]</span><span class="op">]</span></span>
<span>          <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">is.character</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">all_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">all_text</span>, <span class="va">response</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span></span>
<span>          <span class="op">}</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">all_text</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Create a word cloud from discussion text</span></span>
<span><span class="va">create_discussion_wordcloud</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">discussion_text</span>, <span class="va">title</span> <span class="op">=</span> <span class="st">"Discussion Word Cloud"</span>, <span class="va">output_file</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Clean and tokenize text</span></span>
<span>  <span class="va">words</span> <span class="op">&lt;-</span> <span class="va">discussion_text</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove_all</a></span><span class="op">(</span><span class="st">"[[:punct:]]"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove_all</a></span><span class="op">(</span><span class="st">"[[:digit:]]"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html" class="external-link">str_to_lower</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html" class="external-link">str_split</a></span><span class="op">(</span><span class="st">"\\s+"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Remove stop words</span></span>
<span>  <span class="va">stop_words</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"the"</span>, <span class="st">"and"</span>, <span class="st">"a"</span>, <span class="st">"to"</span>, <span class="st">"of"</span>, <span class="st">"is"</span>, <span class="st">"in"</span>, <span class="st">"that"</span>, <span class="st">"this"</span>, <span class="st">"it"</span>, <span class="st">"as"</span>, <span class="st">"for"</span>, <span class="st">"with"</span>, <span class="st">"be"</span>, <span class="st">"are"</span>, <span class="st">"on"</span>, <span class="st">"by"</span>, <span class="st">"an"</span>, <span class="st">"or"</span>, <span class="st">"at"</span>, <span class="st">"but"</span>, <span class="st">"not"</span>, <span class="st">"from"</span>, <span class="st">"have"</span>, <span class="st">"has"</span>, <span class="st">"was"</span>, <span class="st">"were"</span><span class="op">)</span></span>
<span>  <span class="va">words</span> <span class="op">&lt;-</span> <span class="va">words</span><span class="op">[</span><span class="op">!</span><span class="va">words</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">stop_words</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Count word frequencies</span></span>
<span>  <span class="va">word_freq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">words</span><span class="op">)</span></span>
<span>  <span class="va">word_freq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">word_freq</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Create word cloud</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">output_file</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># If output file is specified, save to file</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grDevices/png.html" class="external-link">png</a></span><span class="op">(</span><span class="va">output_file</span>, width <span class="op">=</span> <span class="fl">800</span>, height <span class="op">=</span> <span class="fl">600</span>, res <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu">wordcloud</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">word_freq</span><span class="op">)</span>, freq <span class="op">=</span> <span class="va">word_freq</span>, min.freq <span class="op">=</span> <span class="fl">2</span>, max.words <span class="op">=</span> <span class="fl">100</span>,</span>
<span>              random.order <span class="op">=</span> <span class="cn">FALSE</span>, colors <span class="op">=</span> <span class="fu">brewer.pal</span><span class="op">(</span><span class="fl">8</span>, <span class="st">"Dark2"</span><span class="op">)</span>, main <span class="op">=</span> <span class="va">title</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span>main <span class="op">=</span> <span class="va">title</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co"># Otherwise display in the current device</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu">wordcloud</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">word_freq</span><span class="op">)</span>, freq <span class="op">=</span> <span class="va">word_freq</span>, min.freq <span class="op">=</span> <span class="fl">2</span>, max.words <span class="op">=</span> <span class="fl">100</span>,</span>
<span>              random.order <span class="op">=</span> <span class="cn">FALSE</span>, colors <span class="op">=</span> <span class="fu">brewer.pal</span><span class="op">(</span><span class="fl">8</span>, <span class="st">"Dark2"</span><span class="op">)</span>, main <span class="op">=</span> <span class="va">title</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span>main <span class="op">=</span> <span class="va">title</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Example usage</span></span>
<span><span class="va">cluster_id</span> <span class="op">&lt;-</span> <span class="st">"0"</span>  <span class="co"># Replace with the cluster you want to visualize</span></span>
<span><span class="va">discussion_text</span> <span class="op">&lt;-</span> <span class="fu">extract_discussion_text</span><span class="op">(</span><span class="va">consensus_results</span>, <span class="va">cluster_id</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">discussion_text</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="va">discussion_text</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Save to file</span></span>
<span>  <span class="va">output_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"wordcloud_cluster_"</span>, <span class="va">cluster_id</span>, <span class="st">".png"</span><span class="op">)</span></span>
<span>  <span class="fu">create_discussion_wordcloud</span><span class="op">(</span></span>
<span>    <span class="va">discussion_text</span>,</span>
<span>    title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Cluster"</span>, <span class="va">cluster_id</span>, <span class="st">"Discussion Keywords"</span><span class="op">)</span>,</span>
<span>    output_file <span class="op">=</span> <span class="va">output_file</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Word cloud saved to:"</span>, <span class="va">output_file</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"No discussion text found for cluster"</span>, <span class="va">cluster_id</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="additional-saving-options">Additional Saving Options<a class="anchor" aria-label="anchor" href="#additional-saving-options"></a>
</h3>
<p>For more flexibility in saving your visualizations:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Save a single plot with high resolution</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="st">"cell_type_annotations.png"</span>, plot <span class="op">=</span> <span class="va">p1</span>, width <span class="op">=</span> <span class="fl">10</span>, height <span class="op">=</span> <span class="fl">8</span>, dpi <span class="op">=</span> <span class="fl">600</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save the combined plot with custom dimensions</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="st">"mLLMCelltype_results.png"</span>, plot <span class="op">=</span> <span class="va">simplified_dashboard</span>, width <span class="op">=</span> <span class="fl">20</span>, height <span class="op">=</span> <span class="fl">10</span>, dpi <span class="op">=</span> <span class="fl">300</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save as PDF for vector graphics with compression</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="st">"mLLMCelltype_results.pdf"</span>, plot <span class="op">=</span> <span class="va">simplified_dashboard</span>, width <span class="op">=</span> <span class="fl">20</span>, height <span class="op">=</span> <span class="fl">10</span>, device <span class="op">=</span> <span class="va">cairo_pdf</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="visualization-best-practices">Visualization Best Practices<a class="anchor" aria-label="anchor" href="#visualization-best-practices"></a>
</h3>
<div class="section level4">
<h4 id="color-selection">Color Selection<a class="anchor" aria-label="anchor" href="#color-selection"></a>
</h4>
<ul>
<li>
<strong>Cell Type Annotations</strong>: Use distinct colors for
different cell types</li>
<li>
<strong>Consensus Proportion</strong>: Use a gradient from yellow
(low) to blue (high)</li>
<li>
<strong>Shannon Entropy</strong>: Use a gradient from red (low
uncertainty) to yellow (high uncertainty)</li>
</ul>
</div>
<div class="section level4">
<h4 id="layout-considerations">Layout Considerations<a class="anchor" aria-label="anchor" href="#layout-considerations"></a>
</h4>
<ul>
<li>Arrange plots in a logical order (annotations, consensus,
entropy)</li>
<li>Use consistent point sizes and fonts across plots</li>
<li>Include informative titles and legends</li>
<li>Consider adding cluster labels for easier reference</li>
</ul>
</div>
<div class="section level4">
<h4 id="accessibility">Accessibility<a class="anchor" aria-label="anchor" href="#accessibility"></a>
</h4>
<ul>
<li>Choose colorblind-friendly palettes when possible</li>
<li>Include text labels in addition to colors</li>
<li>Ensure sufficient contrast for readability</li>
<li>Consider alternative representations for complex data</li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="example-complete-visualization-workflow">Example: Complete Visualization Workflow<a class="anchor" aria-label="anchor" href="#example-complete-visualization-workflow"></a>
</h3>
<p>Here’s a complete example workflow for creating publication-ready
visualizations:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cafferyang.com/mLLMCelltype/" class="external-link">mLLMCelltype</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/enblacar/SCpubr/" class="external-link">SCpubr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load data and results</span></span>
<span><span class="co"># Assuming you have a Seurat object and consensus results</span></span>
<span></span>
<span><span class="co"># Add results to Seurat object</span></span>
<span><span class="va">seurat_obj</span><span class="op">$</span><span class="va">cell_type_consensus</span> <span class="op">&lt;-</span> <span class="fu">plyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/mapvalues.html" class="external-link">mapvalues</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://satijalab.github.io/seurat-object/reference/Idents.html" class="external-link">Idents</a></span><span class="op">(</span><span class="va">seurat_obj</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">consensus_results</span><span class="op">$</span><span class="va">final_annotations</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  to <span class="op">=</span> <span class="va">consensus_results</span><span class="op">$</span><span class="va">final_annotations</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract consensus metrics from the consensus results</span></span>
<span><span class="va">consensus_metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">consensus_results</span><span class="op">$</span><span class="va">initial_results</span><span class="op">$</span><span class="va">consensus_results</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">cluster_id</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">metrics</span> <span class="op">&lt;-</span> <span class="va">consensus_results</span><span class="op">$</span><span class="va">initial_results</span><span class="op">$</span><span class="va">consensus_results</span><span class="op">[[</span><span class="va">cluster_id</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    cluster <span class="op">=</span> <span class="va">cluster_id</span>,</span>
<span>    consensus_proportion <span class="op">=</span> <span class="va">metrics</span><span class="op">$</span><span class="va">consensus_proportion</span>,</span>
<span>    entropy <span class="op">=</span> <span class="va">metrics</span><span class="op">$</span><span class="va">entropy</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert to data frame for easier handling</span></span>
<span><span class="va">metrics_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">consensus_metrics</span>, <span class="va">data.frame</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add consensus proportion to Seurat object</span></span>
<span><span class="va">seurat_obj</span><span class="op">$</span><span class="va">consensus_proportion</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu">plyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/mapvalues.html" class="external-link">mapvalues</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://satijalab.github.io/seurat-object/reference/Idents.html" class="external-link">Idents</a></span><span class="op">(</span><span class="va">seurat_obj</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  from <span class="op">=</span> <span class="va">metrics_df</span><span class="op">$</span><span class="va">cluster</span>,</span>
<span>  to <span class="op">=</span> <span class="va">metrics_df</span><span class="op">$</span><span class="va">consensus_proportion</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add entropy to Seurat object</span></span>
<span><span class="va">seurat_obj</span><span class="op">$</span><span class="va">entropy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu">plyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/mapvalues.html" class="external-link">mapvalues</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://satijalab.github.io/seurat-object/reference/Idents.html" class="external-link">Idents</a></span><span class="op">(</span><span class="va">seurat_obj</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  from <span class="op">=</span> <span class="va">metrics_df</span><span class="op">$</span><span class="va">cluster</span>,</span>
<span>  to <span class="op">=</span> <span class="va">metrics_df</span><span class="op">$</span><span class="va">entropy</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create publication-ready visualizations</span></span>
<span><span class="co"># Cell type annotations with SCpubr</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">SCpubr</span><span class="fu">::</span><span class="fu">do_DimPlot</span><span class="op">(</span><span class="va">seurat_obj</span>,</span>
<span>                         group.by <span class="op">=</span> <span class="st">"cell_type_consensus"</span>,</span>
<span>                         label <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                         repel <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                         legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>                         font.size <span class="op">=</span> <span class="fl">14</span>,</span>
<span>                         pt.size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add title using ggplot2</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">p1</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Cell Type Annotations"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Consensus proportion with SCpubr</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">SCpubr</span><span class="fu">::</span><span class="fu">do_FeaturePlot</span><span class="op">(</span><span class="va">seurat_obj</span>,</span>
<span>                            features <span class="op">=</span> <span class="st">"consensus_proportion"</span>,</span>
<span>                            order <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                            pt.size <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>                            colors.use <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"yellow"</span>, <span class="st">"green"</span>, <span class="st">"blue"</span><span class="op">)</span>,</span>
<span>                            legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>                            font.size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add title using ggplot2</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">p2</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Consensus Proportion"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Shannon entropy with SCpubr</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu">SCpubr</span><span class="fu">::</span><span class="fu">do_FeaturePlot</span><span class="op">(</span><span class="va">seurat_obj</span>,</span>
<span>                            features <span class="op">=</span> <span class="st">"entropy"</span>,  <span class="co"># Note: The column name is 'entropy', not 'shannon_entropy'</span></span>
<span>                            order <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                            pt.size <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>                            colors.use <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"orange"</span>, <span class="st">"yellow"</span><span class="op">)</span>,</span>
<span>                            legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>                            font.size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add title using ggplot2</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="va">p3</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Shannon Entropy"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine plots</span></span>
<span><span class="va">combined_plot</span> <span class="op">&lt;-</span> <span class="va">p1</span> <span class="op">|</span> <span class="va">p2</span> <span class="op">|</span> <span class="va">p3</span></span>
<span></span>
<span><span class="co"># Add annotation</span></span>
<span><span class="va">combined_plot</span> <span class="op">&lt;-</span> <span class="va">combined_plot</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html" class="external-link">plot_annotation</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"mLLMCelltype Results"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Cell type annotations with uncertainty metrics"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Created with mLLMCelltype and SCpubr"</span>,</span>
<span>    theme <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>      plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span>, hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>      plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span>, hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>      plot.caption <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Save the visualization</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="st">"mLLMCelltype_visualization.png"</span>,</span>
<span>       plot <span class="op">=</span> <span class="va">combined_plot</span>,</span>
<span>       width <span class="op">=</span> <span class="fl">15</span>,</span>
<span>       height <span class="op">=</span> <span class="fl">8</span>,</span>
<span>       dpi <span class="op">=</span> <span class="fl">300</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Also save as PDF for vector graphics</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="st">"mLLMCelltype_visualization.pdf"</span>,</span>
<span>       plot <span class="op">=</span> <span class="va">combined_plot</span>,</span>
<span>       width <span class="op">=</span> <span class="fl">15</span>,</span>
<span>       height <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="troubleshooting-common-issues">Troubleshooting Common Issues<a class="anchor" aria-label="anchor" href="#troubleshooting-common-issues"></a>
</h3>
<div class="section level4">
<h4 id="scpubr-parameter-compatibility">SCpubr Parameter Compatibility<a class="anchor" aria-label="anchor" href="#scpubr-parameter-compatibility"></a>
</h4>
<p>If you encounter errors with SCpubr functions:</p>
<ul>
<li>The <code>title</code> parameter may not be supported in your
version of SCpubr</li>
<li>Use standard ggplot2 functions to add titles instead:</li>
</ul>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"My Title"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<ul>
<li>Check the SCpubr documentation for your installed version</li>
</ul>
</div>
<div class="section level4">
<h4 id="handling-na-values">Handling NA Values<a class="anchor" aria-label="anchor" href="#handling-na-values"></a>
</h4>
<p>When working with model predictions:</p>
<ul>
<li>Always check for and handle NA values in matrices</li>
<li>Use
<code>unique_types &lt;- unique_types[!is.na(unique_types)]</code> to
remove NA values</li>
<li>Add conditional checks like
<code>if (!is.na(prediction_matrix[i, j]))</code> in loops</li>
</ul>
</div>
<div class="section level4">
<h4 id="discussion-log-extraction">Discussion Log Extraction<a class="anchor" aria-label="anchor" href="#discussion-log-extraction"></a>
</h4>
<p>If you have trouble extracting discussion text:</p>
<ul>
<li>The structure of discussion logs may vary</li>
<li>Use a more robust extraction approach that navigates through the
nested structure</li>
<li>Check that the text is not empty with
<code>nchar(discussion_text) &gt; 0</code>
</li>
</ul>
</div>
<div class="section level4">
<h4 id="wordcloud-dependencies">Wordcloud Dependencies<a class="anchor" aria-label="anchor" href="#wordcloud-dependencies"></a>
</h4>
<p>If wordcloud generation fails:</p>
<ul>
<li>Ensure all required packages are installed: <code>wordcloud</code>,
<code>RColorBrewer</code>, <code>tm</code>
</li>
<li>Consider saving to a file with <code><a href="https://rdrr.io/r/grDevices/png.html" class="external-link">png()</a></code> and
<code><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off()</a></code> instead of displaying directly</li>
<li>Increase memory limits if working with large text corpora</li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="next-steps">Next Steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h3>
<p>Now that you know how to create effective visualizations for
mLLMCelltype results, you can explore:</p>
<ul>
<li>
<a href="07-faq.html">FAQ</a>: Find answers to common questions</li>
<li>
<a href="08-advanced-features.html">Advanced Features</a>: Explore
hierarchical annotation and other advanced features</li>
<li>
<a href="09-contributing-guide.html">Contributing Guide</a>: Learn
how to contribute to the project</li>
<li>
<a href="10-version-history.html">Version History</a>: Review the
development history of mLLMCelltype</li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Chen Yang.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2. <br>© 2024 Chen Yang</p>
</div>

    </footer>
</div>





  </body>
</html>
